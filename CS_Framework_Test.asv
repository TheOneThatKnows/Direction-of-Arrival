%% CS_Framework

clear; clc; close all;

DOA = FunctionsOfDOA();

sensor_locations = [0 1 4 7 9]; % MRA with 5 sensors
M = length(sensor_locations);

K = 2; L = 70; SNR_dB = 15;
phi_min = 30;
phi_max = 150;
delta_phi = 1;
angle_spec = phi_min:delta_phi:phi_max;

doa = DOA.DOA_Generate(K, phi_min, phi_max, delta_phi);
s = DOA.Source_Generate(K, L);
A = DOA.Array_Manifold(0.5, sensor_locations, doa);
C = DOA.Mutual_Coupling(0, 0.1, M, sensor_locations);
n = DOA.Noise_Generate(SNR_dB, M, L);
y = C * A * s + n;

A_sparse = DOA.Array_Manifold(0.5, sensor_locations, angle_spec);

%% CS1

CS = CS_Framework(y, A_sparse);

CS = CS.Steepest_Descent_DOA([1 min(1/L, 0.1)]);

if L ~= 1
    x = var(CS.Sg.').';
    x = abs(x);
else
    x = abs(CS.Sg);
end
x = x / max(x);
figure; plot(angle_spec, 10*log10(x));
title_text = "DOA Angles: " + doa(1) + ", " + doa(2);
title(title_text)

%% CS_Framework_Utilizing_Difference_Coarray 1

Ry = (1 / L) * (y * y');
z = Ry(:);
A_sparse = DOA.Array_Manifold(0.5, sensor_locations, angle_spec);
A1 = DOA.khatri_rao(conj(A_sparse), A_sparse);
I = eye(M); I = I(:);
CS = CS_Framework_Utilizing_Difference_Coarray(z, [A1 I], [1 1]);

CS = CS.Steepest_Descent_DOA();

x = abs(CS.sg(1:end-1));
x = x / max(x);
figure; plot(angle_spec, 10*log10(x));
title_text = "DOA Angles: " + doa(1) + ", " + doa(2);
title(title_text)